<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bewegungsstatistik – Flughafen Zürich – 1. Quadrant</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --primary:#004bb5;
    --primary-light:#e8f0ff;
    --bg:#f4f6fa;
    --card:#ffffff;
    --border:#dcdfe6;
    --text:#1f2937;
    --radius:10px;
    --shadow:0 4px 12px rgba(0,0,0,.06);
    --container:1400px;
  }
  
  *{box-sizing:border-box;}
  
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  
  /* ================= HEADER ================= */
  header {
    max-width: var(--container);
    margin: 24px auto;
    padding: 20px 24px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .header-title {
    font-size: 26px;
    font-weight: 600;
  }
  
  /* Button-Gruppen */
  .button-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }
  
  .button-group.scrollable {
    overflow-x: auto;
    padding-bottom: 4px;
  }
  
  .button-group.scrollable::-webkit-scrollbar {
    height: 6px;
  }
  
  .button-group.scrollable::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
  }
  
  /* Letzte Zeile: Prozedere links, View-Buttons rechts */
  .header-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  
  /* Buttons */
  .btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: #fff;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    transition: background 0.2s;
    white-space: nowrap;
  }
  
  .btn:hover{ background:var(--primary-light); }
  .btn.active{
    background:var(--primary);
    color:#fff;
    border-color:var(--primary);
  }
  
  .custom-date{
    display:none;
    gap:8px;
  }
  
  /* Views */
  .view{
    display:none;
    max-width:var(--container);
    margin:0 auto;
    padding:0 16px 24px;
  }
  .view.active{ display:block; }
  
  /* Cards */
  .card{
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }
  
  /* Charts */
  .charts-wrap{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:16px;
  }
  .chart-box{ height:360px; }
  
  /* Table */
  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }
  th, td{
    padding:8px 10px;
    border-bottom:1px solid var(--border);
  }
  th{
    background:#004bb5;
    color:#fff;
    text-align:left;
  }
  
  /* Footer */
  .footer{
    text-align:center;
    margin:30px 0;
  }
  
  .impressum {
    position: fixed;
    bottom: 10px;
    right: 10px;
    font-size: 12px;
    color: #555;
  }
</style>
</head>

<body>

<header>
  <div class="header-title">Bewegungsstatistik – Flughafen Zürich – 1. Quadrant</div>

  <!-- Zeile 1: Zeitraum -->
  <div class="button-group scrollable" id="time-toggle">
    <button id="btnYesterday" class="btn">Gestern</button>
    <button id="btnToday" class="btn">Heute</button>
    <button id="btnWeek" class="btn">Woche</button>
    <button id="btnMonth" class="btn">Monat</button>
    <button id="btnYear" class="btn">Jahr</button>
    <button id="btnCustom" class="btn">Benutzerdefiniert</button>

    <div class="custom-date">
      <input type="date" id="customStart">
      <input type="date" id="customEnd">
      <button id="applyCustom" class="btn">Anwenden</button>
    </div>
  </div>

  <!-- Zeile 2: Zeitfenster -->
  <div class="button-group" id="time-of-day">
    <button id="tdMorning" class="btn">Morgens 06-07</button>
    <button id="tdDay" class="btn active">Tag 07-22</button>
    <button id="tdNight" class="btn">Nacht 22-06</button>
    <button id="tdAll" class="btn">Ganzer Tag</button>
  </div>

  <!-- Zeile 3: Prozedere links, View-Buttons rechts -->
  <div class="header-bottom">
    <div class="button-group" id="bw-row">
      <button id="bwStart" class="btn active">Abflug</button>
      <button id="bwLand" class="btn">Anflug</button>
      <button id="bwAll" class="btn">Alle</button>
    </div>
    <div class="view-switch">
      <button id="btnCharts" class="btn active">Grafiken</button>
      <button id="btnTable" class="btn">Tabelle</button>
    </div>
  </div>
</header>

<section id="viewCharts" class="view active">
  <div class="charts-wrap">
    <div class="card chart-box"><canvas id="chartRoute"></canvas></div>
    <div class="card chart-box"><canvas id="chartDayNight"></canvas></div>
    <div class="card chart-box"><canvas id="chartRW"></canvas></div>
    <div class="card chart-box"><canvas id="chartFTYP"></canvas></div>
    <div class="card chart-box"><canvas id="chartLK"></canvas></div>
  </div>
</section>

<section id="viewTable" class="view">
  <div class="card" id="table-container"></div>
</section>

<script>
(async function(){

Chart.defaults.font.family =
  'system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif';
Chart.defaults.color = '#1f2937';

const res = await fetch("Data.csv",{cache:"no-store"});
const text = await res.text();
const lines = text.replace(/\r/g,"").trim().split("\n");
if(lines.length < 2) return;

const sep = lines[0].includes(";") ? ";" : ",";
const headers = lines[0].split(sep).map(h=>h.trim());
const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

const bwCol=idx.BW, dtCol=idx.DatZeit_LT, ftypCol=idx.FTYP,
      rwCol=idx.RW, lkCol=idx.LK, routeCol = idx.Route;

function parseDate(v){
  if(!v) return null;
  const [d,t]=v.split(" ");
  const [dd,mm,yy]=d.split(".");
  const [h,m]=t.split(":");
  return new Date(yy,mm-1,dd,h,m);
}

const allRows = lines.slice(1)
  .map(l=>l.split(sep))
  .filter(r=>r[dtCol]);

let bwFilter="S";
let timeFilter=null;
let highlightTime="day";

let chartRoute, chartRW, chartFTYP, chartLK, chartDayNight;

function inTimeRange(v, range){
  const date=parseDate(v);
  if(!date) return false;
  const now=new Date();

  switch(range){
    case "today": return date.toDateString()===now.toDateString();
    case "yesterday":
      const y=new Date(); y.setDate(now.getDate()-1);
      return date.toDateString()===y.toDateString();
    case "week":
      const w=new Date(); w.setDate(now.getDate()-6);
      return date>=w && date<=now;
    case "month":
      return date.getMonth()===now.getMonth() && date.getFullYear()===now.getFullYear();
    case "year":
      return date.getFullYear()===now.getFullYear();
    case "custom":
      if(!customStart.value || !customEnd.value) return true;
      return date>=new Date(customStart.value) && date<=new Date(customEnd.value);
    default: return true;
  }
}

// ===== Buttons =====
bwStart.onclick=()=>{bwFilter="S";setBW(bwStart)};
bwLand.onclick =()=>{bwFilter="L";setBW(bwLand)};
bwAll.onclick  =()=>{bwFilter=null;setBW(bwAll)};
function setBW(btn){ [bwStart,bwLand,bwAll].forEach(b=>b.classList.remove("active")); btn.classList.add("active"); applyFilter(); }

const timeBtns=[btnYesterday,btnToday,btnWeek,btnMonth,btnYear,btnCustom];
timeBtns.forEach(btn=>{
  btn.onclick=()=>{
    timeBtns.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    timeFilter=btn.id.replace("btn","").toLowerCase();
    document.querySelector(".custom-date").style.display=
      timeFilter==="custom"?"flex":"none";
    applyFilter();
  };
});
applyCustom.onclick=()=>applyFilter();

btnCharts.onclick=()=>setView(true);
btnTable.onclick =()=>setView(false);
function setView(charts){
  viewCharts.classList.toggle("active",charts);
  viewTable.classList.toggle("active",!charts);
  btnCharts.classList.toggle("active",charts);
  btnTable.classList.toggle("active",!charts);
}

// ===== Zeitfenster-Buttons =====
tdMorning.onclick=()=>setHighlight("morning");
tdDay.onclick    =()=>setHighlight("day");
tdNight.onclick  =()=>setHighlight("night");
tdAll.onclick    =()=>setHighlight("all");

function setHighlight(h){
  highlightTime=h;
  [tdMorning,tdDay,tdNight,tdAll].forEach(b=>b.classList.remove("active"));
  if(h==="morning") tdMorning.classList.add("active");
  if(h==="day") tdDay.classList.add("active");
  if(h==="night") tdNight.classList.add("active");
  if(h==="all") tdAll.classList.add("active");
  applyFilter();
}

function highlightByTime(r){
  const date=parseDate(r[dtCol]);
  if(!date) return false;
  const h=date.getHours();
  if(highlightTime==="morning") return h>=6 && h<7;
  if(highlightTime==="day") return h>=7 && h<22;
  if(highlightTime==="night") return h>=22 || h<6;
  return true; // all
}

function getBWText(){
  if(bwFilter==="S") return "Abflüge";
  if(bwFilter==="L") return "Anflüge";
  return "An-/Abflüge";
}

function chartOpts(){ return {responsive:true, maintainAspectRatio:false, devicePixelRatio:window.devicePixelRatio||1, animation:false}; }

function updateCharts(rows){
  const countByHighlight=(col)=>{
    const dataMap={};
    rows.forEach(r=>{
      const k=r[col]||"Unbekannt";
      if(!dataMap[k]) dataMap[k]={highlight:0,other:0};
      if(highlightByTime(r)) dataMap[k].highlight++;
      else dataMap[k].other++;
    });
    return dataMap;
  };

  chartRoute?.destroy(); chartRW?.destroy(); chartFTYP?.destroy(); chartLK?.destroy(); chartDayNight?.destroy();

  const makeStackedData=(col)=>{
    const d=countByHighlight(col);
    const labels=Object.keys(d);
    const highlight=labels.map(l=>d[l].highlight);
    const other=labels.map(l=>d[l].other);
    return {labels, highlight, other};
  };

  const barOpts=(title)=>({...chartOpts(), plugins:{title:{display:true,text:title,font:{size:16,weight:'600'}}, legend:{display:false}}});

  // Farben
  const colHighlight='#004bb5', colOther='#d1d5db';

  // Route
  let data=makeStackedData(routeCol);
  chartRoute=new Chart(chartRoute=document.getElementById("chartRoute"),{
    type:'bar',
    data:{labels:data.labels,datasets:[
      {label:'Ausgewählt',data:data.highlight,backgroundColor:colHighlight},
      {label:'Andere',data:data.other,backgroundColor:colOther}
    ]},
    options:{...barOpts(getBWText()+' pro Route'),scales:{x:{stacked:true},y:{stacked:true}}}
  });

  // RW
  data=makeStackedData(rwCol);
  chartRW=new Chart(chartRW=document.getElementById("chartRW"),{
    type:'bar',
    data:{labels:data.labels,datasets:[
      {label:'Ausgewählt',data:data.highlight,backgroundColor:colHighlight},
      {label:'Andere',data:data.other,backgroundColor:colOther}
    ]},
    options:{...barOpts(getBWText()+' pro Piste'),scales:{x:{stacked:true},y:{stacked:true}}}
  });

  // Ftyp
  data=makeStackedData(ftypCol);
  chartFTYP=new Chart(chartFTYP=document.getElementById("chartFTYP"),{
    type:'bar',
    data:{labels:data.labels,datasets:[
      {label:'Ausgewählt',data:data.highlight,backgroundColor:colHighlight},
      {label:'Andere',data:data.other,backgroundColor:colOther}
    ]},
    options:{...barOpts('Flottenmix'),scales:{x:{stacked:true},y:{stacked:true}}}
  });

  // LK
  data=makeStackedData(lkCol);
  chartLK=new Chart(chartLK=document.getElementById("chartLK"),{
    type:'bar',
    data:{labels:data.labels,datasets:[
      {label:'Ausgewählt',data:data.highlight,backgroundColor:colHighlight},
      {label:'Andere',data:data.other,backgroundColor:colOther}
    ]},
    options:{...barOpts('Lärmklasse der Jetflugzeuge'),scales:{x:{stacked:true},y:{stacked:true}}}
  });

  // Tageszeit-Pie
  const dn={Tag:0,Nacht:0};
  rows.forEach(r=>{
    const h=parseDate(r[dtCol]).getHours();
    h>=6&&h<22?dn.Tag++:dn.Nacht++;
  });
  chartDayNight=new Chart(chartDayNight=document.getElementById("chartDayNight"),{
    type:'pie',
    data:{labels:Object.keys(dn),datasets:[{data:Object.values(dn),backgroundColor:['#004bb5','#d1d5db'],hoverOffset:8}]},
    options:{...chartOpts(),plugins:{title:{display:true,text:'Tageszeit',font:{size:16,weight:'600'}}}}
  });
}

function renderTable(rows){
  const dailyMap = {};
  const allRWs = Array.from(new Set(rows.map(r=>r[routeCol]||"Unbekannt"))).sort();

  rows.forEach(r=>{
    const d=parseDate(r[dtCol]);
    if(!d) return;
    const key=`${String(d.getDate()).padStart(2,"0")}.${String(d.getMonth()+1).padStart(2,"0")}.${d.getFullYear()}`;
    const rw=r[routeCol]||"Unbekannt";
    dailyMap[key]??={};
    dailyMap[key][rw]=(dailyMap[key][rw]||0)+1;
  });

  const table=document.createElement("table");
  table.innerHTML="<tr><th>Datum</th>"+allRWs.map(rw=>`<th>${rw}</th>`).join("")+"<th>Total</th></tr>";

  Object.keys(dailyMap).sort().forEach(day=>{
    let total=0;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${day}</td>`;
    allRWs.forEach(rw=>{
      const v=dailyMap[day][rw]||0;
      total+=v;
      tr.innerHTML+=`<td>${v}</td>`;
    });
    tr.innerHTML+=`<td>${total}</td>`;
    table.appendChild(tr);
  });

  document.getElementById("table-container").replaceChildren(table);
}

function applyFilter(){
  let rows=[...allRows];
  if(bwFilter) rows=rows.filter(r=>r[bwCol]===bwFilter);
  if(timeFilter) rows=rows.filter(r=>inTimeRange(r[dtCol],timeFilter));
  const highlightedRows = rows.filter(r=>highlightByTime(r));
  updateCharts(rows);
  renderTable(highlightedRows);
}

applyFilter();
})();
</script>

<div style="text-align:center; margin:30px 0;">
  <a href="index.html" class="btn">Zurück</a>
</div>

<div class="impressum">
  © Abteilung OVL, Flughafen Zürich AG
</div>

</body>
</html>
